---
title: "Cox Hazard"
author: "Brian Callander"
date: "2018-08-18"
always_allow_html: yes
output: 
  md_document:
    variant: markdown
    preserve_yaml: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  cache = TRUE, 
  comment = NA,
  message = FALSE,
  warning = TRUE,
  error = TRUE,
  knitr.table.format = 'html'
)

library(tidyverse)
library(broom)
library(scales)

library(rstan)
library(tidybayes)
library(bayesplot)

library(survival)
library(survminer)

library(kableExtra)

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```


## Data

### Raw

```{r}
data("mastectomy", package = "HSAUR")

df <- mastectomy %>% 
  as_tibble() %>% 
  arrange(time) %>% 
  transmute(
    id = 1:n(),
    months = time,
    event,
    metastized = metastized == 'yes'
  ) 

df %>% 
  head() %>% 
  kable() %>% kable_styling()
```

```{r}
df %>% 
  ggplot(aes(x = event, y = ..count../sum(..count..))) +
  geom_bar(position = 'stack') +
  scale_y_continuous(labels = percent)
```

```{r}
df %>% 
  ggplot(aes(y = months, x = reorder(id, months), fill = event, width = 0.2)) +
  geom_col() +
  geom_point(aes(alpha = metastized)) +
  coord_flip() +
  labs(
    y = 'Months',
    x = 'Person',
    fill = 'Event?'
  ) 
```

### Prepared for hazard modelling

```{r}
M <- 3 # size of intervals

df1 <- 
  # all combos of person and interval
  expand.grid(
    id = df$id,                           # person
    lower = seq(0, max(df$months) + M, M) # interval lower bound
  ) %>% 
  as_tibble() %>% 
  
  # add strict upper bound for the interval
  mutate(upper = lower + M) %>% 
  
  # add data for each person
  inner_join(df, by = 'id') %>% 
  
  # exclude people that died in a previous interval
  # if months lies on the lower bound, assign death to previous interval
  filter(lower < months) %>% 
  
  # add death and exposure info
  mutate(
    death = if_else(event & months <= upper, 1, 0),
    exposure = pmin(months - lower, M)
  ) %>% 
  arrange(id, lower)
```

Let's take a look at some entries to see what this looks like. We should see 

* a row for every interval in which the person was part of the experiment
* the sum of the exposures is equal to `months`
* `death` is 1 for the last interval if there was no censoring, or 0 otherwise

```{r}
df1 %>% 
  filter(id == 2) %>% 
  kable() %>% kable_styling()
```

In the case that the event occurred on the lower boundary of an interval, we assign the event to the previous interval. This is why we see a death in interval [15, 18) with exposure 3, rather than in interval [18, 21) with exposure 0. We do this because exposure 0 doesn't make much sense.

```{r}
df1 %>% 
  filter(id == 5) %>% 
  kable() %>% kable_styling()
```

For censored cases, `death` is always 0.

```{r}
df1 %>% 
  filter(id == 21) %>% 
  kable() %>% kable_styling()
```

We can check these properties for the whole dataset. First, exposure is never zero.

```{r}
min(df1$exposure)
```

The sum of the exposures is equal to the time to observation.

```{r}
df1 %>% 
  group_by(id) %>% 
  summarise(correct = max(months) == sum(exposure)) %>% 
  count(correct) %>% 
  kable() %>% kable_styling()

```

The sum of all `death`s is equal to the censoring status.

```{r}
df1 %>% 
  group_by(id) %>% 
  summarise(correct = sum(death) == max(if_else(event, 1, 0))) %>% 
  count(correct) %>% 
  kable() %>% kable_styling()

```

## Model

```{r}
model <- rstan::stan_model('poisson_regression.stan')
model
```

```{r}
fit <- sampling(
  model,
  data = df1 %>% 
           compose_data(
             m = df1 %>% distinct(lower) %>% nrow(), 
             I = model.matrix(~ 0 + ordered(lower), df1),
             h_sh = 2, h_ra = 2,
             beta_sigma = 5
           ),
  iter = 3000,
  warmup = 500
)

fit
```

### Diagnostics

```{r}
fit %>% 
  rhat() %>% 
  summary()

```

```{r}
fit %>% 
  neff_ratio() %>% 
  summary()
```

```{r}
fit %>% 
  neff_ratio() %>% 
  tidy() %>% 
  filter(x < 1)

```

```{r}
fit %>% 
  as.array() %>% 
  mcmc_acf(pars = c('beta', 'lp__'))

```


```{r}
fit %>% 
  as.array() %>% 
  mcmc_trace(pars = c('beta', 'lp__')) 

```

### Effects

```{r}
p <- fit %>% 
  spread_draws(beta, h[idx]) %>% 
  mutate(
    lower = (idx - 1) * M,
    meta = h * exp(beta + log(M))
  ) %>% 
  mean_qi()
  
p %>% 
  head()
```


```{r}
p %>% 
  select(lower, h, meta) %>%
  gather(group, estimate, h, meta) %>%
  group_by(group) %>%
  arrange(lower) %>%
  mutate(
    cum_h = cumsum(estimate),
    survival = exp(-cum_h)
  ) %>%
  ggplot(aes(x = lower, y = survival, colour = group)) +
  geom_step()

```

```{r}
cx <- coxph(
  formula = Surv(months, event) ~ metastized,
  data = df
)

cx
```

```{r}
tibble(x = seq(0, 3, 0.001), y = dgamma(x, 2, 2)) %>% 
  ggplot(aes(x = x, y = y)) + geom_line()


```

