<!DOCTYPE html>

<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">

    <link rel="stylesheet" href="../../css/default.css">

    <link rel="alternate" type="application/atom+xml" title="Brian's feed" href="atom.xml" />

    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

    <title>Brian - BDA3 Chapter 5 Exercise 6</title>
  </head>

  <body>
    <nav id="navbar-container" class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container">
        <a class="navbar-brand mr-5" href="https://www.briancallander.com">Brian</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div id="navbar" class="collapse navbar-collapse justify-content-end">
          <ul class="nav navbar-nav">
            <li class="nav-item"><a class="nav-link" href="https://www.briancallander.com"><i class="fas fa-home"></i> Recent</a></li>
            <li class="nav-item"><a class="nav-link" href="https://www.briancallander.com"><i class="fas fa-archive"></i> Archive</a></li>
            <li class="nav-item"><a class="nav-link" href="https://twitter.com/mcbricall"><i class="fab fa-twitter"></i></a></li>
            <li class="nav-item"><a class="nav-link" href="https://github.com/stappit"><i class="fab fa-github"></i></a></li>
            <li class="nav-item"><a class="nav-link" href="https://www.linkedin.com/in/brian-callander-ba4117140/"><i class="fab fa-linkedin-in"></i></a></li>
            <li class="nav-item"><a class="nav-link" href="https://www.strava.com/athletes/6396953"><i class="fab fa-strava"></i></a></li>
            <li class="nav-item"><a class="nav-link" href="https://www.instagram.com/macbricall/"><i class="fab fa-instagram"></i></a></li>
            <li class="nav-item"><a class="nav-link" href="https://www.briancallander.com"><i class="far fa-envelope"></i></a></li>
            <li class="nav-item"><a class="nav-link" href="https://www.briancallander.com"><i class="fas fa-rss"></i></a></li>
            <li class="nav-item"><a class="nav-link" href="https://www.briancallander.com"><i class="fas fa-info-circle"></i> About</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <section>
      <article>
        <div id="content" class="container">
          <h1 class="post-title">BDA3 Chapter 5 Exercise 6</h1>

<div class="card post-meta border-0">
  <div class="card-body post-meta">
    <p class="card-text text-muted text-left">
    Posted on November 11, 2018  by Brian </br>
     Tags: <a href="../../tags/bda%20chapter%205.html">bda chapter 5</a>, <a href="../../tags/solutions.html">solutions</a>, <a href="../../tags/bayes.html">bayes</a>, <a href="../../tags/mixture.html">mixture</a>, <a href="../../tags/exchangeability.html">exchangeability</a>, <a href="../../tags/divorce%20rates.html">divorce rates</a> </br>
     Category: <a href="../../categories/bda3.html">bda3</a> 
    </p>
  </div>
</div>

<p>Here’s my solution to exercise 6, chapter 5, of <a href="https://andrewgelman.com/">Gelman’s</a> <em>Bayesian Data Analysis</em> (BDA), 3rd edition. There are <a href="http://www.stat.columbia.edu/~gelman/book/solutions.pdf">solutions</a> to some of the exercises on the <a href="http://www.stat.columbia.edu/~gelman/book/">book’s webpage</a>.</p>
<!--more-->
<div style="display:none">
<p class="mathjaxWide"><span class="math inline">\(\DeclareMathOperator{\dbinomial}{Binomial} \DeclareMathOperator{\dbern}{Bernoulli} \DeclareMathOperator{\dpois}{Poisson} \DeclareMathOperator{\dnorm}{Normal} \DeclareMathOperator{\dt}{t} \DeclareMathOperator{\dcauchy}{Cauchy} \DeclareMathOperator{\dexponential}{Exp} \DeclareMathOperator{\duniform}{Uniform} \DeclareMathOperator{\dgamma}{Gamma} \DeclareMathOperator{\dinvgamma}{InvGamma} \DeclareMathOperator{\invlogit}{InvLogit} \DeclareMathOperator{\logit}{Logit} \DeclareMathOperator{\ddirichlet}{Dirichlet} \DeclareMathOperator{\dbeta}{Beta}\)</span></p>
</div>
<p>We are given that the divorce rates (per thousand population) for eight states were recorded, two of which were Utah and Nevada. However, we are not told which rates correspond to which states. We are then given the rates for the first seven of the selected states and we need to calculate the posterior for the divorce rate of the remaining state.</p>
<p>Our prior needs to be exchangeable, and to take into account the fact that one state (Utah) is likely to have an especially low divorce rate and that other (Nevada) is likely to have an especially high divorce rate. If we knew that <span class="math inline">\(y_1\)</span> and <span class="math inline">\(y_2\)</span> were Utah and Nevada, respectively, we could use the following product of betas</p>
<p class="mathjaxWide"><span class="math display">\[
p(\theta_1, \dotsc, \theta_8)
=
\dbeta(\theta_1 \mid \alpha_l, \beta_l)
\cdot
\dbeta(\theta_2 \mid \alpha_h, \beta_h)
\cdot
\prod_{i = 3}^8
\dbeta(\theta_i \mid \alpha_m, \beta_m)
,
\]</span></p>
<p>where <span class="math inline">\((\alpha_l, \beta_l)\)</span>, <span class="math inline">\((\alpha_m, \beta_m)\)</span>, and <span class="math inline">\((\alpha_h, \beta_h)\)</span> have most of their density on low, medium, and high values, respectively. Since we don’t know which belong to Utah and Nevada, we can average this density over all possible combinations:</p>
<p class="mathjaxWide"><span class="math display">\[
p(\theta_1, \dotsc, \theta_8)
=
\frac{1}{56}
\sum_f
\dbeta(\theta_{f(1)} \mid \alpha_l, \beta_l)
\cdot
\dbeta(\theta_{f(2)} \mid \alpha_h, \beta_h)
\cdot
\prod_{i = 3}^8
\dbeta(\theta_{f(i)} \mid \alpha_m, \beta_m)
,
\]</span></p>
<p>where <span class="math inline">\(f: \{1, \dotsc, 8 \} \to \{1, \dotsc, 8 \}\)</span> is either identity or is a permuation such that 1 and 2 are not both fixed points. There are <span class="math inline">\(2 \binom{8}{2} = 8 \times 7 = 56\)</span> such functions.</p>
<p>We’ll use the following hyperpriors.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">low &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">alpha =</span> <span class="dv">7</span>, <span class="dt">beta =</span> <span class="dv">2000</span> <span class="op">-</span><span class="st"> </span><span class="dv">7</span>)
medium &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">alpha =</span> <span class="dv">65</span>, <span class="dt">beta =</span> <span class="dv">10000</span> <span class="op">-</span><span class="st"> </span><span class="dv">65</span>)
high &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">alpha =</span> <span class="dv">22</span>, <span class="dt">beta =</span> <span class="dv">2000</span> <span class="op">-</span><span class="st"> </span><span class="dv">22</span>)</code></pre></div>
<p>The medium prior has probability mass 2.33%, 3.75% below and above 0.5%, 0.8%, respecitvely, with a mean value of 0.65%. The low and high priors have a lower precision but with means that are lower and higher than 0.65%, respectively. They also overlap somewhat with the medium prior, but with lower density. This overlapping could allow the possibility that Nevada/Utah don’t have such extreme values in the year of observation.</p>
<figure>
<img src="chapter_05_exercise_06_files/figure-markdown/priors_plot-1..svg" />
</figure>
<p>The posterior for the eighth state is</p>
<p class="mathjaxWide"><span class="math display">\[
p(\theta_8 \mid \theta_1, \dotsc, \theta_7)
=
\frac{p(\theta_1, \dotsc, \theta_8)}{p(\theta_1, \dotsc, \theta_7)}
.
\]</span></p>
<p>We can plot this posterior by writing functions for the denominator and numerator. First the numerator.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">djoint8 &lt;-<span class="st"> </span><span class="cf">function</span>(x) {
  
  <span class="co"># x is a vector of length 8</span>
  
  <span class="co"># calculate the densities once</span>
  hdensity &lt;-<span class="st"> </span>x <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">map_dbl</span>(dbeta, high<span class="op">$</span>alpha, high<span class="op">$</span>beta)
  mdensity &lt;-<span class="st"> </span>x <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">map_dbl</span>(dbeta, medium<span class="op">$</span>alpha, medium<span class="op">$</span>beta)
  ldensity &lt;-<span class="st"> </span>x <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">map_dbl</span>(dbeta, low<span class="op">$</span>alpha, low<span class="op">$</span>beta)

  <span class="co"># i is the index for the low divorce rate state</span>
  <span class="co"># j is the index for the high divorce rate state</span>
  <span class="co"># k is the index for the medium divorce rate states</span>
  <span class="kw">expand.grid</span>(<span class="dt">i =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">8</span>, <span class="dt">j =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">8</span>, <span class="dt">k =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">8</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(i <span class="op">!=</span><span class="st"> </span>j <span class="op">&amp;</span><span class="st"> </span>i <span class="op">!=</span><span class="st"> </span>k <span class="op">&amp;</span><span class="st"> </span>j <span class="op">!=</span><span class="st"> </span>k) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">m =</span> mdensity[k]) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(i, j) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">m =</span> <span class="kw">prod</span>(m)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">density =</span> m <span class="op">*</span><span class="st"> </span>ldensity[i] <span class="op">*</span><span class="st"> </span>hdensity[j]) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="co"># average over all choices of i, j</span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="kw">mean</span>(density)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">pull</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">return</span>()
}

<span class="fl">0.0065</span> <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rep</span>(<span class="dv">8</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">djoint8</span>()</code></pre></div>
<pre><code>[1] 9.611221e+18</code></pre>
<p>Now the denominator. Given the ordering, the joint prior is independent. This means that integrating out the eighth state simply means dropping any density for the eighth state.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">djoint7 &lt;-<span class="st"> </span><span class="cf">function</span>(x) {
  
  <span class="co"># x is a vector of length 7</span>

  hdensity &lt;-<span class="st"> </span>x <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">map_dbl</span>(dbeta, high<span class="op">$</span>alpha, high<span class="op">$</span>beta)
  mdensity &lt;-<span class="st"> </span>x <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">map_dbl</span>(dbeta, medium<span class="op">$</span>alpha, medium<span class="op">$</span>beta)
  ldensity &lt;-<span class="st"> </span>x <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">map_dbl</span>(dbeta, low<span class="op">$</span>alpha, low<span class="op">$</span>beta)

  <span class="co"># We drop the eighth state from the medium components</span>
  <span class="co"># by limiting the range of k</span>
  <span class="kw">expand.grid</span>(<span class="dt">i =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">8</span>, <span class="dt">j =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">8</span>, <span class="dt">k =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">7</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(i <span class="op">!=</span><span class="st"> </span>j <span class="op">&amp;</span><span class="st"> </span>i <span class="op">!=</span><span class="st"> </span>k <span class="op">&amp;</span><span class="st"> </span>j <span class="op">!=</span><span class="st"> </span>k) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">m =</span> mdensity[k]) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(i, j) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">m =</span> <span class="kw">prod</span>(m)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(
      <span class="co"># if i or j is the eighth state,</span>
      <span class="co"># we drop it</span>
      <span class="co"># otherwise we have both factors</span>
      <span class="dt">density =</span> m <span class="op">*</span><span class="st"> </span><span class="kw">case_when</span>(
        j <span class="op">==</span><span class="st"> </span><span class="dv">8</span> <span class="op">~</span><span class="st"> </span>ldensity[i],
        i <span class="op">==</span><span class="st"> </span><span class="dv">8</span> <span class="op">~</span><span class="st"> </span>hdensity[j],
        <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> </span>ldensity[i] <span class="op">*</span><span class="st"> </span>hdensity[j]
      )
    ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="kw">mean</span>(density)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">pull</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">return</span>()
}

<span class="fl">0.0065</span> <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rep</span>(<span class="dv">7</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">djoint7</span>()</code></pre></div>
<pre><code>[1] 1.103857e+17</code></pre>
<p>The posterior is then just the ratio of the two densities given above.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">y &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">5.8</span>, <span class="fl">6.6</span>, <span class="fl">7.8</span>, <span class="fl">5.6</span>, <span class="fl">7.0</span>, <span class="fl">7.1</span>, <span class="fl">5.4</span>) <span class="op">/</span><span class="st"> </span><span class="dv">1000</span>

dposterior &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">.y =</span> y) {
  z &lt;-<span class="st"> </span><span class="kw">c</span>(.y, x)
  <span class="kw">djoint8</span>(z) <span class="op">/</span><span class="st"> </span><span class="kw">djoint7</span>(.y)
}

<span class="kw">dposterior</span>(<span class="fl">0.006</span>)</code></pre></div>
<pre><code>[1] 157.0397</code></pre>
<p>Let’s calculate the posterior on a grid with the bulk of the density.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">granularity &lt;-<span class="st"> </span><span class="fl">0.00005</span>

posterior &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">p =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="fl">0.03</span>, granularity)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">density =</span> <span class="kw">map_dbl</span>(p, dposterior))</code></pre></div>
<p>To check that we have most of the density, we can calculate the area under the density curve on our grid. It is 100%, which is encouraging.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">posterior <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="kw">sum</span>(density) <span class="op">*</span><span class="st"> </span>granularity) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pull</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">percent</span>()</code></pre></div>
<pre><code>[1] &quot;100%&quot;</code></pre>
<p>We can also check the probability of observing a value at least as extreme as the value actually observed.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">extreme &lt;-<span class="st"> </span>posterior <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(p <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.0139</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="kw">sum</span>(density) <span class="op">*</span><span class="st"> </span>granularity) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pull</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">percent</span>()

extreme </code></pre></div>
<pre><code>[1] &quot;4.22%&quot;</code></pre>
<p>The posterior has the following shape. There are three modes since the eighth state can correspond to a low, medium, or high divorce rate.</p>
<figure>
<img src="chapter_05_exercise_06_files/figure-markdown/posterior_plot-1..svg" />
</figure>

<div id="disqus_thread"></div>
<script>
/**
 *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
 *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
 */
/*
   var disqus_config = function () {
   this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
   this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
   };
 */
(function() {  // DON'T EDIT BELOW THIS LINE
 var d = document, s = d.createElement('script');

 s.src = '//stappit-github-io.disqus.com/embed.js';

 s.setAttribute('data-timestamp', +new Date());
 (d.head || d.body).appendChild(s);
 })();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

<script id="dsq-count-scr" src="//stappit-github-io.disqus.com/count.js" async></script>

        </div>
      </article>
    </section>

    <footer class="footer">
      <div class="container text-center">
        Site proudly generated by
        <a href="http://jaspervdj.be/hakyll">Hakyll</a>
      </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  </body>
</html>
